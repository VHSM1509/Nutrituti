<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutri-App Prototipo</title>
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel desde CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root" class="h-screen w-screen"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { jsPDF } = window.jspdf;

        // --- SIMULACIÓN DE API Y BASE DE DATOS ---
        // En un proyecto real, esto sería reemplazado por llamadas a la API del backend.
        const db = {
            users: [
                { id: 1, name: 'Dra. Ana López', email: 'ana@nutri.com', role: 'nutriologo' },
                { id: 2, name: 'Carlos Sánchez', email: 'carlos@mail.com', role: 'paciente' },
                { id: 3, name: 'Laura Gómez', email: 'laura@mail.com', role: 'paciente' },
            ],
            patients: [
                { id: 101, userId: 2, dob: '1990-05-15', phone: '5512345678', history: 'Sin alergias conocidas.' },
                { id: 102, userId: 3, dob: '1985-11-22', phone: '5587654321', history: 'Intolerante a la lactosa.' },
            ],
            menus: [
                { id: 1001, patientId: 101, nutritionistId: 1, name: 'Plan de Inicio - Quema Grasa', active: true, content: {
                    Desayuno: ['- 1 taza de avena con fresas y nueces.', '- 1 taza de té verde.'],
                    Almuerzo: ['- 150g de pechuga de pollo a la plancha.', '- Ensalada verde con aguacate y tomate.', '- 1/2 taza de arroz integral.'],
                    Cena: ['- Sopa de lentejas.', '- 1 rebanada de pan integral con aguacate.'],
                    Colaciones: ['- 1 manzana.', '- Un puñado de almendras.']
                }},
            ],
        };

        const api = {
            login: (email) => new Promise((resolve, reject) => {
                const user = db.users.find(u => u.email === email);
                setTimeout(() => user ? resolve(user) : reject('Usuario no encontrado'), 300);
            }),
            getPatients: () => new Promise((resolve) => {
                const patientsWithDetails = db.patients.map(p => ({
                    ...p,
                    ...db.users.find(u => u.id === p.userId)
                }));
                setTimeout(() => resolve(patientsWithDetails), 300);
            }),
            getPatientById: (id) => new Promise((resolve) => {
                 const patient = db.patients.find(p => p.id === id);
                 const user = db.users.find(u => u.id === patient.userId);
                 setTimeout(() => resolve({...patient, ...user}), 300);
            }),
            getPatientMenu: (patientId) => new Promise((resolve) => {
                const menu = db.menus.find(m => m.patientId === patientId && m.active);
                setTimeout(() => resolve(menu), 300);
            }),
            saveMenu: (patientId, menuContent) => new Promise((resolve) => {
                const existingMenu = db.menus.find(m => m.patientId === patientId);
                if (existingMenu) {
                    existingMenu.content = menuContent.content;
                    existingMenu.name = menuContent.name;
                } else {
                    const newMenu = {
                        id: Math.random(),
                        patientId,
                        nutritionistId: 1, // Hardcoded for this demo
                        name: menuContent.name,
                        active: true,
                        content: menuContent.content
                    };
                    db.menus.push(newMenu);
                }
                setTimeout(() => resolve(true), 300);
            }),
        };

        // --- COMPONENTES DE UI ---

        const Spinner = () => (
            <div className="flex justify-center items-center p-8">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-500"></div>
            </div>
        );

        const Card = ({ children, className }) => (
            <div className={`bg-white p-6 rounded-xl shadow-md ${className}`}>
                {children}
            </div>
        );

        // --- PANTALLA DE LOGIN ---
        function LoginScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                api.login(email)
                    .then(user => onLogin(user))
                    .catch(err => setError(err))
                    .finally(() => setLoading(false));
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100">
                    <Card className="w-full max-w-md">
                        <h1 className="text-3xl font-bold text-teal-600 text-center mb-2">Nutri-App</h1>
                        <p className="text-center text-slate-500 mb-6">Bienvenido/a</p>
                        <form onSubmit={handleLogin}>
                            <p className="text-sm mb-4">Usa uno de estos correos para ingresar:</p>
                            <ul className="text-sm text-slate-600 list-disc list-inside mb-4 bg-slate-50 p-3 rounded-lg">
                                <li><span className="font-semibold">Nutriólogo:</span> ana@nutri.com</li>
                                <li><span className="font-semibold">Paciente:</span> carlos@mail.com</li>
                                <li><span className="font-semibold">Paciente:</span> laura@mail.com</li>
                            </ul>
                            <input
                                type="email"
                                value={email}
                                onChange={e => setEmail(e.target.value)}
                                placeholder="Ingresa tu correo electrónico"
                                className="w-full px-4 py-2 border border-slate-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-teal-500"
                            />
                            {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold hover:bg-teal-600 transition duration-300 disabled:bg-slate-400"
                            >
                                {loading ? 'Ingresando...' : 'Ingresar'}
                            </button>
                        </form>
                    </Card>
                </div>
            );
        }

        // --- DASHBOARD DEL NUTRIÓLOGO ---
        function NutritionistDashboard({ user, onLogout }) {
            const [patients, setPatients] = useState([]);
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.getPatients().then(data => {
                    setPatients(data);
                    setLoading(false);
                });
            }, []);

            if (loading) return <Spinner />;

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-teal-600">Dashboard Nutriólogo</h1>
                            <p className="text-slate-500">Bienvenida, {user.name}</p>
                        </div>
                        <button onClick={onLogout} className="bg-slate-200 px-4 py-2 rounded-lg hover:bg-slate-300 transition">Salir</button>
                    </header>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <Card className="lg:col-span-1">
                            <h2 className="text-xl font-bold mb-4">Lista de Pacientes</h2>
                            <ul>
                                {patients.map(p => (
                                    <li key={p.id} onClick={() => setSelectedPatient(p)}
                                        className={`p-3 rounded-lg cursor-pointer transition ${selectedPatient?.id === p.id ? 'bg-teal-100 text-teal-800' : 'hover:bg-slate-100'}`}>
                                        <p className="font-semibold">{p.name}</p>
                                        <p className="text-sm text-slate-500">{p.email}</p>
                                    </li>
                                ))}
                            </ul>
                        </Card>

                        <div className="lg:col-span-2">
                           {selectedPatient ? 
                                <PatientDetails patient={selectedPatient} /> :
                                <Card className="flex items-center justify-center h-full">
                                    <p className="text-slate-500">Selecciona un paciente para ver sus detalles y menú.</p>
                                </Card>
                            }
                        </div>
                    </div>
                </div>
            );
        }

        function PatientDetails({ patient }) {
            const [menu, setMenu] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isEditing, setIsEditing] = useState(false);
            const [editedMenu, setEditedMenu] = useState({});

            useEffect(() => {
                setLoading(true);
                api.getPatientMenu(patient.id).then(data => {
                    setMenu(data);
                    setEditedMenu(data || { name: `Plan para ${patient.name}`, content: { Desayuno: [], Almuerzo: [], Cena: [] } });
                    setLoading(false);
                });
            }, [patient.id]);

            const handleSaveMenu = () => {
                api.saveMenu(patient.id, editedMenu).then(() => {
                    setMenu(editedMenu);
                    setIsEditing(false);
                });
            };
            
            const handleContentChange = (meal, index, value) => {
                const newContent = { ...editedMenu.content };
                newContent[meal][index] = value;
                setEditedMenu({ ...editedMenu, content: newContent });
            };
            
             const handleAddItem = (meal) => {
                const newContent = { ...editedMenu.content };
                if(!newContent[meal]) newContent[meal] = [];
                newContent[meal].push('');
                setEditedMenu({ ...editedMenu, content: newContent });
            };

            const handleRemoveItem = (meal, index) => {
                const newContent = { ...editedMenu.content };
                newContent[meal].splice(index, 1);
                setEditedMenu({ ...editedMenu, content: newContent });
            }

            if (loading) return <Spinner />;

            return (
                 <Card>
                    <h2 className="text-xl font-bold mb-1">{patient.name}</h2>
                    <p className="text-slate-500 mb-4">{patient.email} | Tel: {patient.phone}</p>
                    <div className="bg-slate-50 p-4 rounded-lg mb-6">
                        <h3 className="font-semibold text-slate-700">Historial</h3>
                        <p className="text-sm text-slate-600">{patient.history}</p>
                    </div>

                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">Plan de Alimentación</h3>
                         {isEditing ? (
                            <div>
                               <button onClick={() => setIsEditing(false)} className="bg-slate-200 px-3 py-1 rounded-lg text-sm mr-2 hover:bg-slate-300">Cancelar</button>
                               <button onClick={handleSaveMenu} className="bg-teal-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-teal-600">Guardar</button>
                            </div>
                        ) : (
                            <button onClick={() => setIsEditing(true)} className="bg-teal-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-teal-600">Editar Menú</button>
                        )}
                    </div>
                    
                    {isEditing ? (
                        <div className="space-y-4">
                            <input type="text" value={editedMenu.name} onChange={e => setEditedMenu({...editedMenu, name: e.target.value})} className="w-full text-lg font-semibold p-2 border rounded-lg"/>
                            {Object.entries(editedMenu.content).map(([meal, items]) => (
                                <div key={meal}>
                                    <h4 className="font-semibold text-teal-700 mb-2">{meal}</h4>
                                    {items.map((item, index) => (
                                        <div key={index} className="flex items-center mb-2">
                                            <input type="text" value={item} onChange={(e) => handleContentChange(meal, index, e.target.value)} className="w-full p-2 border rounded-lg mr-2"/>
                                            <button onClick={() => handleRemoveItem(meal, index)} className="text-red-500 hover:text-red-700">X</button>
                                        </div>
                                    ))}
                                    <button onClick={() => handleAddItem(meal)} className="text-sm text-teal-600 hover:underline mt-1">+ Agregar platillo</button>
                                </div>
                            ))}
                        </div>
                    ) : (
                        menu ? (
                            <div>
                                <h3 className="font-semibold text-lg mb-4">{menu.name}</h3>
                                <div className="space-y-4">
                                    {Object.entries(menu.content).map(([meal, items]) => (
                                        <div key={meal}>
                                            <h4 className="font-semibold text-teal-700">{meal}</h4>
                                            <ul className="list-disc list-inside text-slate-600">
                                                {items.map((item, index) => <li key={index}>{item}</li>)}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : <p className="text-slate-500">Este paciente aún no tiene un menú asignado.</p>
                    )}
                 </Card>
            );
        }

        // --- DASHBOARD DEL PACIENTE ---
        function PatientDashboard({ user, onLogout }) {
            const [patientData, setPatientData] = useState(null);
            const [menu, setMenu] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const patient = db.patients.find(p => p.userId === user.id);
                if (patient) {
                    api.getPatientById(patient.id).then(setPatientData);
                    api.getPatientMenu(patient.id).then(setMenu).finally(() => setLoading(false));
                }
            }, [user.id]);

            const downloadPdf = () => {
                const doc = new jsPDF();
                let y = 20;

                doc.setFontSize(22);
                doc.text("Plan de Alimentación", 105, y, { align: 'center' });
                y += 10;

                doc.setFontSize(16);
                doc.text(menu.name, 105, y, { align: 'center' });
                y += 15;
                
                doc.setFontSize(12);
                doc.text(`Paciente: ${patientData.name}`, 15, y);
                y += 10;

                Object.entries(menu.content).forEach(([meal, items]) => {
                    doc.setFont(undefined, 'bold');
                    doc.text(meal, 15, y);
                    y += 7;
                    doc.setFont(undefined, 'normal');
                    items.forEach(item => {
                        doc.text(item, 20, y);
                        y += 7;
                        if (y > 280) { // Salto de página
                            doc.addPage();
                            y = 20;
                        }
                    });
                     y += 5;
                });
                
                doc.save(`Menu-${patientData.name.replace(' ', '_')}.pdf`);
            };

            if (loading) return <Spinner />;

            return (
                <div className="p-4 md:p-8 max-w-4xl mx-auto">
                     <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-teal-600">Mi Perfil de Paciente</h1>
                            <p className="text-slate-500">Bienvenido, {user.name}</p>
                        </div>
                        <button onClick={onLogout} className="bg-slate-200 px-4 py-2 rounded-lg hover:bg-slate-300 transition">Salir</button>
                    </header>
                    <Card>
                        {menu ? (
                            <>
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h2 className="text-2xl font-bold">{menu.name}</h2>
                                        <p className="text-slate-500">Tu plan de alimentación activo.</p>
                                    </div>
                                    <button onClick={downloadPdf} className="bg-teal-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-600 transition">
                                        Descargar PDF
                                    </button>
                                </div>
                                <div className="space-y-6 bg-slate-50 p-6 rounded-lg">
                                    {Object.entries(menu.content).map(([meal, items]) => (
                                        <div key={meal}>
                                            <h4 className="font-bold text-xl text-teal-700 mb-2">{meal}</h4>
                                            <ul className="list-disc list-inside space-y-1 text-slate-700 pl-2">
                                                {items.map((item, index) => <li key={index}>{item}</li>)}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </>
                        ) : (
                            <p className="text-center text-slate-500 py-12">Aún no tienes un menú asignado. Contacta a tu nutriólogo.</p>
                        )}
                    </Card>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL DE LA APP ---
        function App() {
            const [user, setUser] = useState(null);

            const handleLogin = (loggedInUser) => {
                setUser(loggedInUser);
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (!user) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            if (user.role === 'nutriologo') {
                return <NutritionistDashboard user={user} onLogout={handleLogout} />;
            }

            if (user.role === 'paciente') {
                return <PatientDashboard user={user} onLogout={handleLogout} />;
            }
            
            return <p>Rol de usuario desconocido.</p>;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
